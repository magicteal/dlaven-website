import { Router } from "express";
import { login, me, register, logout, forgotPassword, resetPassword, updateProfile, getAddress, updateAddress, listAddresses, createAddress, updateAddressById, deleteAddressById, setDefaultAddress } from "../controllers/authController";
import { requireAuth, requireAdmin } from "../middleware/auth";
import { User } from "../models/User";

const router = Router();

router.post("/register", register);
router.post("/login", login);
router.post("/logout", logout);
router.get("/me", requireAuth, me);
router.patch("/profile", requireAuth, updateProfile);
router.post("/forgot-password", forgotPassword);
router.post("/reset-password", resetPassword);
router.get("/address", requireAuth, getAddress);
router.patch("/address", requireAuth, updateAddress);

// Addresses CRUD
router.get("/addresses", requireAuth, listAddresses);
router.post("/addresses", requireAuth, createAddress);
router.patch("/addresses/:id", requireAuth, updateAddressById);
router.delete("/addresses/:id", requireAuth, deleteAddressById);
router.patch("/addresses/:id/default", requireAuth, setDefaultAddress);

// Admin-only user management
router.get("/users", requireAuth, requireAdmin, async (_req, res) => {
	const users = await User.find({}, { passwordHash: 0, __v: 0 }).sort({ createdAt: -1 }).lean();
	res.json({ users });
});

router.patch("/users/:id", requireAuth, requireAdmin, async (req, res) => {
	const { id } = req.params;
	const { name, role } = req.body as { name?: string; role?: "user" | "admin" };
	const toUpdate: Record<string, unknown> = {};
	if (typeof name === "string") toUpdate.name = name;
	if (role === "user" || role === "admin") toUpdate.role = role;
	const user = await User.findByIdAndUpdate(id, toUpdate, { new: true, projection: { passwordHash: 0, __v: 0 } }).lean();
	if (!user) return res.status(404).json({ error: "Not found" });
	res.json({ user });
});

router.delete("/users/:id", requireAuth, requireAdmin, async (req, res) => {
	const { id } = req.params;
	const deleted = await User.findByIdAndDelete(id).lean();
	if (!deleted) return res.status(404).json({ error: "Not found" });
	res.json({ ok: true });
});

	export default router;
